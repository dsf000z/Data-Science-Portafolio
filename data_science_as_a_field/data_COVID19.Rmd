---
title: "Report on COVID19 Data"
author: "David SÃ¡nchez"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
Sys.setlocale("LC_TIME", "English")
options(width = 60)  # Force text wrapping
```

#### Data

```{r import-csse}
# Import global COVID-19 statistics aggregated by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University.

csse_global_deaths <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
csse_global_cases <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
csse_us_deaths <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv")
csse_us_cases <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")

# Import global population estimates from the World Bank.

global_population_estimates <- read_csv("data/global_population_estimates.csv")
```

##### Daily Cases

```{r tidy and daily}

# cases
csse_us_cases_tidy <- csse_us_cases %>% 
  pivot_longer(contains("/"), 
               names_to = "date", 
               values_to = "cases") %>% 
  filter(cases != 0)

# deaths
csse_us_deaths_tidy <- csse_us_deaths %>% 
  pivot_longer(contains("/"), 
               names_to = "date", 
               values_to = "deaths") %>% 
  filter(deaths != 0)

# join and tidy
csse_us <- full_join(csse_us_cases_tidy, csse_us_deaths_tidy) %>% 
  mutate(Country_Region = "United States",
         deaths = replace_na(deaths, 0), # NAs to 0s
         date = mdy(date)) %>%  # store date correctly
  rename(province_or_state = Province_State, 
         country = Country_Region,
         Long = Long_,
         population = Population)

# by state
csse_us_state <- csse_us %>%
  group_by(date, province_or_state) %>% # renaming while we are here
  summarise(country = "United States",
            population = sum(population, na.rm = T), 
            total_deaths = sum(deaths, na.rm = T), 
            total_cases = sum(cases, na.rm = T))

# texas
csse_us_texas <- csse_us_state %>% 
  filter(province_or_state == "Texas")
csse_us_texas %>% 
  head(10)

# Visualizations

# Cases
  ggplot() +
  geom_line(data = csse_us_texas, 
            aes(x = date, 
                y = total_cases)) +
  scale_y_continuous(
    name = "Cases",
    labels = function(cases) format(cases, big.mark = ",", scientific = FALSE)) +
  labs(title = "Texas COVID-19 Cases", 
       x = "Date")

# Deaths
  ggplot() +
  geom_line(data = csse_us_texas, 
            aes(x = date, 
                y = total_deaths)) +
  scale_y_continuous(name = "Deaths") +
  labs(title = "Texas COVID-19 Deaths", 
       x = "Date")
```

We can see that deaths and cases and completely correlated on the state of Texas and probably at large, following mostly the same trends, although at the tail end we can see the deaths petering off more quickly than the cases, with vulnerable populations being vaccinated helping tremendously. The surges and valleys of COVID is also noticeable and further analysis could be done.

```{r ranking}

# combine and tidy the CSSE death and cases data sets

# cases
csse_global_cases_tidy <- csse_global_cases %>% 
  pivot_longer(cols = contains("/2"), 
               names_to = "date", 
               values_to = "cases") %>% 
  filter(cases != 0)

# deaths
csse_global_deaths_tidy <- csse_global_deaths %>% 
  pivot_longer(contains("/2"), 
               names_to = "date", 
               values_to = "deaths") %>% 
  filter(deaths != 0)

# join and tidy
csse_global_province <- full_join(csse_global_cases_tidy,
                                       csse_global_deaths_tidy) %>% 
  mutate(deaths = replace_na(deaths, 0),
         date = mdy(date)) %>% 
  rename(country = "Country/Region",
         province_or_state = "Province/State") %>% 
  full_join(csse_us) %>% # adding US
  select(province_or_state:deaths)

# country summary
csse_global_country <- csse_global_province %>% 
  group_by(country, date) %>% 
  summarise(total_cases = sum(cases, na.rm = T),
            total_deaths = sum(deaths, na.rm = T))

# tidy the global population estimates

tidy_global_population_estimates <- global_population_estimates %>% 
  pivot_longer(cols = starts_with("202"), 
               names_to = "year", 
               values_to = "n") %>% 
  select(country = "Country Name", #also renaming
         year,
         n) %>% 
  mutate(year = str_replace_all(string = year, 
                                pattern = "^202(.).*", 
                                replacement = "202\\1"))

# join and tidy
csse_global <- full_join(csse_global_country, tidy_global_population_estimates) %>%
  mutate(population = case_when(
    grepl("^2020", date) & grepl("2020", year) ~ n,
    grepl("^2021", date) & grepl("2021", year) ~ n,
    grepl("^2022", date) & grepl("2022", year) ~ n,
    grepl("^2023", date) & grepl("2023", year) ~ n)) %>% 
  select(country, population, date, total_cases, total_deaths) %>% 
  filter(!is.na(population)) %>% 
  mutate(population = as.numeric(population))

# per 100k
csse_global2 <- csse_global %>% 
  mutate(cases_per_100k = round(total_cases / population * 100000, 2),
         deaths_per_100k = round(total_deaths / population * 100000, 2))
  
# ranking by cases
rank_cases_total <- csse_global2 %>% 
  filter(date == "2023-03-09") %>% 
  arrange(desc(cases_per_100k)) %>% 
  select(country, cases_per_100k)
rank_cases_10 <- rank_cases_total %>% 
    head(10) 
rank_cases_10

# ranking by deaths
rank_deaths_total <- csse_global2 %>% 
  filter(date == "2023-03-09") %>% 
  arrange(desc(deaths_per_100k)) %>% 
  select(country, deaths_per_100k)
rank_deaths_10 <- rank_deaths_total %>% 
    head(10)
rank_deaths_10
```

##### Rankings

Up until March 9th, 2023, `r format(rank_cases_10$country[1])` was the country with the most cases per 100,000 people, `r format(rank_cases_10$cases_per_100k[1], big.mark=",")` to be exact. `r format(rank_deaths_10$country[1])` occupied the same spot for deaths, sitting at `format(rank_deaths_10$deaths_per_100k, big.mark=",")` per 100,000 people.

There is no overlap between the countries with the most cases and the most deaths, so there doesn't seem to be a direct correlation within this two variables.

```{r vis rankings}
# ordering
global_top_cases <- csse_global2 %>% 
  filter(country == rank_cases_10$country) %>% 
  select(country, date, cases_per_100k) %>% 
  arrange(date) #just to confirm I have the right countries

global_top_deaths <- csse_global2 %>% 
  filter(country == rank_deaths_10$country) %>% 
  select(country, date, deaths_per_100k) %>% 
  arrange(date) 

# Cases
ggplot(global_top_cases, 
       aes(date,
           cases_per_100k, 
           color = fct_reorder2(country, date, cases_per_100k),
           linetype = fct_reorder2(country, date, cases_per_100k))) +
  geom_line() +
  labs(color = "Country",
       linetype = "Country",
       y = "Cases per 100,000 people")

# Deaths
ggplot(global_top_deaths, 
       aes(date,
           deaths_per_100k, 
           color = fct_reorder2(country, date, deaths_per_100k),
           linetype = fct_reorder2(country, date, deaths_per_100k))) +
  geom_line() +
  labs(color = "Country",
       linetype = "Country",
       y = "Deaths per 100,000 peoplr")
```

This visualization is very useful to see degrees of infectiousness and lethality, for example we can see in the "deaths" table that Peru is not just the country that fared off the worst, but that it did so with a big lead to the other 9 countries on the graph. Impression which is exacerbated by the fact that it isn't even on the top 10 countries with more cases per 100,000 residents. both graphs also show that while infection spikes in countries seem to be relatively independent, spikes in deaths happened at similar times.

```{r other countries}
# Daily cases
csse_global3 <- csse_global2 %>% 
  group_by(country) %>% 
  mutate(new_cases =  total_cases - lag(total_cases),
         new_deaths = total_deaths - lag(total_deaths),
         new_cases_per_100k = round(new_cases / population * 100000, 2),
         new_deaths_per_100k = round(new_deaths / population * 100000, 2))

# Countries
csse_america <- csse_global3 %>% 
  filter(country == c("United States", "Canada", "Mexico", "Cuba")) 

# Cases
ggplot(csse_america, 
       aes(date,
           new_cases_per_100k, 
           color = country,
           linetype = country)) +
  geom_smooth() +
  labs(color = "Country",
       linetype = "Country",
       y = "Daily Cases per 100,000 people")

# Deaths
ggplot(csse_america, 
       aes(date,
           new_deaths_per_100k, 
           color = country,
           linetype = country)) +
  geom_smooth() +
  labs(color = "Country",
       linetype = "Country",
       y = "Daily Deaths per 100,000 people")
```

Comparing with other country we can see that both Mexico and the U.S. had a real difference on their cases vs deaths, implying a higher problem with lethality which was controlled by the end of 2021 (US deaths seem to stay the same but in actually the cases increased exponentially with the deaths staying controlled at the same level).

##### Model

```{r early pandemic model}
early_pandemic <- csse_global3 %>% filter(date <= ymd("2020-04-30"))
model <- lm(log(total_cases + 1) ~ date, data = early_pandemic)
summary(model)

```

This models shows the early growth of the pandemic, each additional day is associated with a 0.06907 increase in the log of case counts, which is around a 7% daily growth rate. this meas that it doubled every 10 days globally.

##### Biases

As every country has different protocols in place and detention methods there is a likelihood that our comparisons are not fully accurate, this includes the deaths were some countries may ascribe the cause of death to COVID even if it was only a secondary condition or the other way around were a symptom of the disease is confused as the cause of death. The rurality of the region would also affect the report, with some places not having anyone to diagnose or report to.

```{r}
sessionInfo()
```
